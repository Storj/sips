```
Title: Deterministic Bucket and File Keys
Author: Chris Pollard <chris@storj.io>
Status: Draft
Type: Standard
Created: 2016-10-23
```

Abstract
--------

Calculate bucket and file ids deterministically based on the user id, bucket name, and file name. This should allow direct file and bucket lookups by name and allow users to know the ids before creation, which is required for the HD file key update. This method of generating deterministic ids will still avoid conflicts across users and across buckets.

Motivation
----------

Storj currently uses autogenerated Mongo Ids for new files and buckets. This id is returned to users after the creation request. All Storj users must then keep track of and assosciate these ids with the original file themselves.

This SIP proposes making these ids calculated deterministically directly by user id, bucket name, and file id. Specifically, the bucket id will be the first 12 bytes of `sha256rmd160(userId + bucketName)` and the file id will be the first 12 bytes of `sha256rmd160(bucketId + fileName)`. This will mean the newly generated ids are still compatible with the older Mongo Ids.

Doing this will allow the user to "lookup" these ids client-side without needing to list all buckets or list all the files in a bucket. This will allow for a more intuitive programming interface, since users can refer to buckets and files by name instead of id. It will allow web developers to reference files and buckets by name when we create the browser javascript library.


Specification
-------------

The bucket id will equal the hex encoded value of the first twelve bytes of the user id concatenated with bucket name. The file id will equal the hex encoded value of the first twelve bytes of the bucket id concatenated with the file name. The Javascript implementation is shown below.

```javascript
/**
 * Calculate bucket id from a given user id and bucket name
 * @param {String} user - user id
 * @param {String} bucketName - bucket name
 */
module.exports.calculateBucketId = function(user, bucketName) {
  var rmd160sha256 = module.exports.rmd160sha256;
  var hash = rmd160sha256(user + bucketName, 'utf-8');
  return hash.substring(0, 24);
};

/**
 * Calculate file id from a given bucket id and file name
 * @param {String} bucket - bucket id
 * @param {String} fileName - file name
 */
module.exports.calculateFileId = function(bucket, fileName) {
  var rmd160sha256 = module.exports.rmd160sha256;
  var hash = rmd160sha256(bucket + fileName, 'utf-8');
  return hash.substring(0, 24);
};

```

### Integration

Handling Conflicts
------------------

Users can no longer upload files with the same name to the same bucket, nor create multiple buckets with the same name. Instead of throwing an error, core-cli should prepend the current date enclosed in parenthesis. If this string is detected when a user requests to download the file, it should be stripped to restore the original file name.

```javascript
// creating the new file name

var newFileName = '(' + new Date().toISOString() + ') ' + originalFileName;
```

```javascript
// stripping the date from the file beginning

var _stripISOString = function(fileName){
  var array = fileName.split(' ');
  var potentialDate = array[0];
  var re = /\(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z\)/g;
  var isValid = potentialDate.match(re);
  if (isValid){
    return array.splice(1).join(' ');
  } else {
    return fileName
  }
};
```

Reference By Name
-----------------

Core-CLI should be updated to acccept either bucket ids/ bucket names, as well as file ids/ file names. Theusers can check whether the supplied argument is a valid Mongo Id, If not, it should treat it as a name and use the deterministic id calculation functions to calculate ids. If it is, it should be treated as an id. Some users might want to name their buckets with valid Mongo Ids. If so, they can supply a new --by-name flag to core-cli which will force the valid mongo ids to be treated as names.